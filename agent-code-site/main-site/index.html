<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seoul Tree Support System</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-logo">
                <span class="tree-icon">üå≥</span>
                <span>Seoul Tree Support</span>
            </div>
            <nav class="header-nav">
                <button class="nav-link" onclick="showPage('list')">View Requests</button>
                <button class="nav-link" onclick="showPage('create')">Submit Request</button>
                <div class="branch-indicator" id="branchIndicator" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 6px;">
                        <path d="M11.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122V6A2.5 2.5 0 0110 8.5H6a1 1 0 00-1 1v1.128a2.251 2.251 0 11-1.5 0V5.372a2.25 2.25 0 111.5 0v1.836A2.492 2.492 0 016 7h4a1 1 0 001-1v-.628A2.25 2.25 0 019.5 3.25zM4.25 12a.75.75 0 100 1.5.75.75 0 000-1.5zM3.5 3.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0z"></path>
                    </svg>
                    <span class="branch-name" id="branchName"></span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Request List Page -->
    <div id="listPage" class="page-view active">
        <div class="request-list-container">
            <div class="list-header">
                <h1>Support Requests</h1>
                <div class="request-count">
                    Total: <strong id="requestCount">0</strong>
                </div>
            </div>
            <div class="request-list" id="requestList">
                <!-- Request cards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Request Detail Page -->
    <div id="detailPage" class="page-view">
        <div class="detail-container">
            <button class="back-btn" onclick="showPage('list')">‚Üê Back to Requests</button>
            <div class="detail-card">
                <div class="detail-header-section">
                    <h1 class="detail-title" id="detailTitle"></h1>
                    <div class="detail-meta">
                        <span id="detailDate"></span>
                        <span id="detailAuthor"></span>
                        <span id="detailStatus"></span>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Tree Information</h3>
                    <div class="detail-grid" id="detailTreeInfo"></div>
                    <div class="detail-map-container">
                        <div id="detailMap" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Request Description</h3>
                    <div class="detail-description" id="detailDescription"></div>
                </div>

                <div class="detail-section">
                    <h3>Contact Information</h3>
                    <div class="detail-grid" id="detailContact"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Request Page -->
    <div id="createPage" class="page-view">
        <div class="request-form-container">
            <div class="form-header">
                <h1>Submit Tree Support Request</h1>
                <p>Report tree issues, request maintenance, or emergency support</p>
            </div>

            <form class="request-form" id="requestForm" onsubmit="submitRequest(event)">
                <!-- Map Selection Section -->
                <div class="map-section">
                    <h3>üìç Select a Tree</h3>
                    <div class="map-widget">
                        <div class="search-bar">
                            <input type="text" id="treeSearch" placeholder="Search by tree ID or location..." />
                        </div>
                        <div style="position: relative;">
                            <div id="map"></div>
                            <div class="legend">
                                <h4>Tree Health</h4>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #10b981;"></div>
                                    <span>Excellent (8-10)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #06b6d4;"></div>
                                    <span>Good (6-7)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #f59e0b;"></div>
                                    <span>Fair (4-5)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #ef4444;"></div>
                                    <span>Poor (1-3)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="treeSelection">
                        <!-- Selected tree info or notice will appear here -->
                    </div>
                </div>

                <!-- Request Type -->
                <div class="form-group">
                    <label class="form-label">Request Type <span class="required">*</span></label>
                    <select class="form-select" id="requestType" required>
                        <option value="">Select a type...</option>
                        <option value="pruning">Pruning</option>
                        <option value="disease">Disease/Pest</option>
                        <option value="hazard">Hazard</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label class="form-label">Description <span class="required">*</span></label>
                    <textarea class="form-textarea" id="description" required placeholder="Please describe the issue or request in detail..."></textarea>
                </div>

                <!-- Contact Information -->
                <div class="form-group">
                    <label class="form-label">Your Name <span class="required">*</span></label>
                    <input type="text" class="form-input" id="contactName" required placeholder="Full name" />
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number <span class="required">*</span></label>
                    <input type="tel" class="form-input" id="contactPhone" required placeholder="010-1234-5678" />
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="contactEmail" placeholder="email@example.com (optional)" />
                </div>

                <button type="submit" class="btn btn-primary btn-full" id="submitBtn" disabled>
                    Submit Request
                </button>
            </form>
        </div>
    </div>

    <!-- Chat Widget -->
    <div id="chatWidget" class="chat-widget">
        <!-- Chat Button -->
        <button id="chatButton" class="chat-button" onclick="toggleChat()">
            <span class="chat-icon">üí¨</span>
            <span class="chat-badge" id="chatBadge" style="display: none;">1</span>
        </button>

        <!-- Chat Panel -->
        <div id="chatPanel" class="chat-panel hidden">
            <div class="chat-header">
                <div class="chat-header-content">
                    <h3>ü§ñ AI Assistant</h3>
                    <span class="chat-status" id="chatStatus">
                        <span class="status-dot disconnected"></span>
                        Connecting...
                    </span>
                </div>
                <button class="close-button" onclick="toggleChat()">‚úï</button>
            </div>

            <!-- Preview Notification -->
            <div id="previewNotification" class="preview-notification hidden">
                <div class="preview-content">
                    <p><strong>üéâ Preview Ready!</strong></p>
                    <p>Your changes are ready to view. Click "View Preview" to see them!</p>
                    <div class="preview-actions-row">
                        <button onclick="viewPreview()" class="preview-btn">View Preview</button>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <p>Hi! I'm your AI assistant. I can help you improve this website!</p>
                    <p>How can I help you today?</p>
                </div>
            </div>

            <div class="chat-input-container">
                <textarea
                    id="chatInput"
                    class="chat-input"
                    placeholder="Ask me to modify the website..."
                    rows="1"
                    onkeydown="handleChatKeydown(event)"
                ></textarea>
                <div class="chat-input-actions">
                    <button id="sendButton" class="send-button" onclick="sendChatMessage()">
                        <span>Send</span>
                    </button>
                    <button id="cancelButton" class="cancel-button hidden" onclick="cancelChatMessage()">
                        <span>Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal hidden">
        <div class="preview-modal-backdrop" onclick="closePreview()"></div>
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <h3>üìã Preview - <span id="previewBranchName"></span></h3>
                <div class="preview-modal-actions">
                    <button class="apply-changes-button" onclick="applyChanges()">
                        ‚úì Apply Changes
                    </button>
                    <button class="close-button-modal" onclick="closePreview()">‚úï</button>
                </div>
            </div>
            <iframe id="previewFrame" class="preview-frame"></iframe>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal hidden">
        <div class="confirm-modal-backdrop" onclick="closeConfirmModal()"></div>
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3>üîÑ Apply These Changes?</h3>
            </div>
            <div class="confirm-modal-body">
                <p>This will:</p>
                <ul>
                    <li><strong>Apply changes to your personal site</strong> - visible immediately</li>
                    <li><strong>Submit for admin approval</strong> - required to go live on main site</li>
                </ul>
                <p class="confirm-note">Your changes will be saved and sent to the admin queue for review before appearing on the main site.</p>
            </div>
            <div class="confirm-modal-footer">
                <button class="confirm-cancel-btn" onclick="closeConfirmModal()">Cancel</button>
                <button class="confirm-apply-btn" onclick="confirmApplyChanges()">Apply & Submit</button>
            </div>
        </div>
    </div>

    <!-- Username Modal -->
    <div id="usernameModal" class="confirm-modal" style="display: none;">
        <div class="confirm-modal-backdrop"></div>
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3>Welcome! üëã</h3>
            </div>
            <div class="confirm-modal-body">
                <p>Please enter your name to get started:</p>
                <input type="text" id="usernameInput" placeholder="Your name" style="width: 100%; padding: 0.75rem; margin-top: 1rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" autofocus>
            </div>
            <div class="confirm-modal-footer">
                <button class="confirm-apply-btn" onclick="submitUsername()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO for Chat -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Update branch indicator
        async function updateBranchIndicator() {
            try {
                const res = await fetch('/api/git/branch', { credentials: 'include' });
                const data = await res.json();
                if (data.branch) {
                    document.getElementById('branchIndicator').style.display = 'flex';
                    document.getElementById('branchName').textContent = data.branch;
                }
            } catch (err) {
                console.error('Failed to fetch branch:', err);
            }
        }

        // Check if user is logged in
        async function checkLogin() {
            // If we're in an iframe (preview mode)
            if (window.self !== window.top) {
                console.log('Running in iframe (preview mode)');
                console.log('Cookies in iframe:', document.cookie);

                // Hide the chat widget in iframe
                const chatWidget = document.getElementById('chatWidget');
                if (chatWidget) {
                    chatWidget.style.display = 'none';
                }

                // Try to get username from cookie in iframe
                const cookie = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('agent_code_username='));
                const username = cookie ? decodeURIComponent(cookie.split('=')[1]) : null;

                if (username) {
                    console.log('Preview loaded for user:', username);
                    // Could show username somewhere in preview if needed
                }
                return;
            }

            try {
                const res = await fetch('/api/user/me', { credentials: 'include' });
                const data = await res.json();

                if (!data.loggedIn) {
                    // Don't show login modal in iframe (preview mode)
                    if (window.self === window.top) {
                        document.getElementById('usernameModal').style.display = 'block';
                    }
                } else {
                    console.log('Logged in as:', data.username);
                    // Update branch indicator after confirming login
                    await updateBranchIndicator();
                }
            } catch (err) {
                console.error('Failed to check login:', err);
                // Don't show login modal in iframe (preview mode)
                if (window.self === window.top) {
                    document.getElementById('usernameModal').style.display = 'block';
                }
            }
        }

        async function submitUsername() {
            console.log('submitUsername called');
            const username = document.getElementById('usernameInput').value.trim();
            console.log('Username entered:', username);

            if (!username) {
                alert('Please enter your name');
                return;
            }

            try {
                console.log('Sending login request...');
                const res = await fetch('/api/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username })
                });

                console.log('Login response status:', res.status);
                const data = await res.json();
                console.log('Login response data:', data);

                if (data.success) {
                    document.getElementById('usernameModal').style.display = 'none';
                    console.log('Logged in successfully as:', data.username);

                    // Wait a moment for cookie to be set by browser, then connect to socket
                    setTimeout(() => {
                        if (typeof connectSocket === 'function') {
                            console.log('Connecting socket after login...');
                            connectSocket();
                        }
                    }, 100);

                    // Update branch indicator after successful login
                    await updateBranchIndicator();
                } else {
                    console.error('Login failed:', data.error);
                    alert('Login failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Login error:', err);
                alert('Failed to login: ' + err.message);
            }
        }

        // Handle Enter key in username input
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup Enter key handler
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        submitUsername();
                    }
                });
            }

            // Check login status on page load
            await checkLogin();
        });
    </script>
    <script src="script.js"></script>
</body>
</html>
