<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Tree Support System</title>
    <link rel="stylesheet" href="styles.css?v=8" />
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-logo">
                <span class="tree-icon">üå≥</span>
                <span>Admin Dashboard</span>
            </div>
            <div class="header-nav">
                <button class="nav-link" onclick="window.location.href='/site'">Back to Site</button>
                <button class="nav-link" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- Recent Modifications Table -->
        <div class="modifications-section">
            <div class="modifications-header">
                <h2>Recent AI Modification Requests</h2>
                <div class="status-filters">
                    <button class="filter-btn" data-status="all" onclick="filterRequests('all')">
                        All <span class="filter-count" id="allCount">0</span>
                    </button>
                    <button class="filter-btn active" data-status="pending" onclick="filterRequests('pending')">
                        ‚è≥ Pending <span class="filter-count" id="pendingCount">0</span>
                    </button>
                    <button class="filter-btn" data-status="approved" onclick="filterRequests('approved')">
                        ‚úÖ Approved <span class="filter-count" id="approvedCount">0</span>
                    </button>
                    <button class="filter-btn" data-status="rejected" onclick="filterRequests('rejected')">
                        ‚ùå Rejected <span class="filter-count" id="rejectedCount">0</span>
                    </button>
                </div>
            </div>

            <div id="modificationsTableBody">
                <!-- Request cards will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'pending';
        let allRequests = [];

        // Logout
        function logout() {
            window.location.href = '/site';
        }

        // Load stats and requests on page load
        async function loadDashboard() {
            await loadStats();
            await loadRequests(currentFilter);
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/queue/stats');

                const stats = await response.json();
                const total = (stats.pending || 0) + (stats.approved || 0) + (stats.rejected || 0);
                document.getElementById('allCount').textContent = total;
                document.getElementById('pendingCount').textContent = stats.pending || 0;
                document.getElementById('approvedCount').textContent = stats.approved || 0;
                document.getElementById('rejectedCount').textContent = stats.rejected || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load requests
        async function loadRequests(status = 'pending') {
            try {
                const url = status === 'all'
                    ? '/api/admin/queue?status=all'
                    : `/api/admin/queue?status=${status}`;

                const response = await fetch(url);

                const data = await response.json();
                allRequests = data.requests || [];
                renderRequests(allRequests);
            } catch (error) {
                console.error('Error loading requests:', error);
                const container = document.getElementById('modificationsTableBody');
                if (container) {
                    container.innerHTML = '<p style="text-align:center;padding:2rem;color:#666;">Error loading requests</p>';
                }
            }
        }

        // Render requests
        function renderRequests(requests) {
            const container = document.getElementById('modificationsTableBody');

            if (!requests || requests.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:2rem;color:#666;">No requests found</p>';
                return;
            }

            container.innerHTML = requests.map(request => {
                // Get first user message from conversation history
                const firstUserMsg = request.conversationHistory?.find(msg => msg.role === 'user');
                const requestText = firstUserMsg?.content || request.description;

                return `
                    <div class="mod-request" data-status="${request.status}">
                        <div class="mod-request-header">
                            <span class="mod-date">${new Date(request.timestamp).toLocaleDateString()}</span>
                            <span class="status-badge status-${request.status}">${request.status}</span>
                        </div>
                        <div class="mod-request-body">
                            <div class="mod-requester">
                                <strong>${request.username}</strong>
                            </div>
                            <div class="mod-request-text">
                                "${requestText}"
                            </div>
                            <div class="mod-meta">
                                <span class="code-tag">${request.branchName}</span>
                                ${request.featureBranch ? `<span class="code-tag">${request.featureBranch}</span>` : ''}
                            </div>
                        </div>
                        <div class="table-action-buttons">
                            ${request.status === 'pending' ? `
                                <button class="action-btn approve" onclick="approveRequest('${request.id}')">
                                    ‚úÖ Approve
                                </button>
                                <button class="action-btn reject" onclick="rejectRequest('${request.id}')">
                                    ‚ùå Reject
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter requests
        function filterRequests(status) {
            currentFilter = status;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });

            loadRequests(status);
        }

        // Approve request
        async function approveRequest(requestId) {
            try {
                const response = await fetch(`/api/admin/approve/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ adminName: 'Admin', note: '' })
                });

                const result = await response.json();

                if (response.ok) {
                    loadDashboard();
                } else {
                    console.error('Error approving:', result.error);
                }
            } catch (error) {
                console.error('Error approving request:', error);
            }
        }

        // Reject request
        async function rejectRequest(requestId) {
            try {
                const response = await fetch(`/api/admin/reject/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ adminName: 'Admin', note: 'Rejected' })
                });

                const result = await response.json();

                if (response.ok) {
                    loadDashboard();
                } else {
                    console.error('Error rejecting:', result.error);
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
            }
        }

        // Load dashboard on page load
        loadDashboard();

        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
